function EPIPhaseCorrection( MR )
% Overload EPI phase correction function

% logic
if ~strcmpi(MR.Parameter.Scan.FastImgMode,'EPI')
    return; end

% Dimensionality
Kd=MR.UMCParameters.AdjointReconstruction.KspaceSize{1};
Id=MR.Parameter.Gridder.OutputMatrixSize{1};

% Reshape calibration data to [Kd(1) Kd(2) Kd(4)]
calib_data=permute(reshape(MR.UMCParameters.SystemCorrections.CalibrationData,[Kd(1) Kd(4) Kd(2)]),[1 3 4 2]);
MR.UMCParameters.SystemCorrections.CalibrationData=[];

% 1D NUFFT along readout direction for phase correction
calib_data=epi_1D_M_nufft(MR,calib_data,1);

% Transform angle information to k-space for easy addition
% Requires magnitude 1 data
calib_data=calib_data./abs(calib_data);

% Inverse nufft
calib_data=exp(-1j.*calib_data);
calib_data=calib_data.*epi_1D_M_nufft(MR,MR.Data{1},1);
calib_data=epi_1D_M_nufft(MR,MR.Data{1},1);

%MR.Data{1}=epi_1D_M_nufft(MR,calib_data,0);
% Estimate phase errors from calibration data
%err=crosscorrelation(calib_data);

MR.Data{1}=MR.Data{1}(:,1:2:end,:,:);
% END
end


%n1d_for=@(y)(nufft(y,d));
